import httpx
import logging
from openai import AsyncOpenAI
from bot.config import config

logger = logging.getLogger(__name__)

class LLMClient:
    def __init__(self):
        if config.OPENROUTER_API_KEY:
            # ‚úÖ –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç—ã
            # connect: –≤—Ä–µ–º—è –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
            # read: —Å–∫–æ–ª—å–∫–æ –∂–¥–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–∞ (—Å—Ç–∞–≤–∏–º 90 —Å–µ–∫, —á—Ç–æ–±—ã Llama —É—Å–ø–µ–ª–∞ –ø–æ–¥—É–º–∞—Ç—å)
            timeout = httpx.Timeout(
                connect=10.0,
                read=90.0, 
                write=10.0,
                pool=10.0,
            )
            
            # –ü–µ—Ä–µ–¥–∞–µ–º timeout –≤ –∫–ª–∏–µ–Ω—Ç
            http_client = httpx.AsyncClient(timeout=timeout)

            self.client = AsyncOpenAI(
                api_key=config.OPENROUTER_API_KEY,
                base_url=config.OPENROUTER_BASE_URL,
                http_client=http_client,
            )
        else:
            self.client = None

    # üëá –≠–¢–û–¢ –ú–ï–¢–û–î –û–°–¢–ê–í–õ–Ø–ï–ú –ö–ê–ö –ë–´–õ –£ –í–ê–° (–æ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)
    def build_prompt(self, user_query: str, law_context: str, web_results: str, history: str) -> str:
        prompt = f"""
–¢—ã ‚Äî –Ω–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç‚Äë—ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º—É –ø—Ä–∞–≤—É (–ù–ö –†–§, —Å–∞–Ω–∫—Ü–∏–∏, –≤–∞–ª—é—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ).
–†–∞–±–æ—Ç–∞–µ—à—å —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω—É ‚Äî —É–∫–∞–∂–∏ —ç—Ç–æ –∏ –¥–∞–π –æ–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –º–µ—Å—Ç–Ω–æ–º—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.

–ù–ê–õ–û–ì–û–í–´–ï –†–ï–ñ–ò–ú–´:
- –ù–µ –¥–µ–ª–∞–π –≤—ã–≤–æ–¥–æ–≤ –æ —Ä–µ–∂–∏–º–µ (–û–°–ù–û, –£–°–ù, –ï–°–•–ù, –ü–°–ù), –µ—Å–ª–∏ –æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω.
- –£–ø–æ–º–∏–Ω–∞–π —Ä–µ–∂–∏–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞: (–∞) –æ–Ω –ø—Ä—è–º–æ –Ω–∞–∑–≤–∞–Ω, –∏–ª–∏ (–±) —Ä–µ–∂–∏–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—ã–≤–æ–¥—ã.
- –ï—Å–ª–∏ —Ä–µ–∂–∏–º –≤–∞–∂–µ–Ω, –Ω–æ –Ω–µ —É–∫–∞–∑–∞–Ω: –Ω–∞–ø–∏—à–∏, —á—Ç–æ —Ä–µ–∂–∏–º –Ω–µ —É—Ç–æ—á–Ω—ë–Ω, –ø–æ–ø—Ä–æ—Å–∏ –µ–≥–æ —É–∫–∞–∑–∞—Ç—å –∏ –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ —Ä–∞–∑–ª–∏—á–∏—è –≤ –≤—ã–≤–æ–¥–∞—Ö.
- –î–ª—è –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–ª–æ–≥ –Ω–∞ –∏–º—É—â–µ—Å—Ç–≤–æ –ø–æ –∫–∞–¥–∞—Å—Ç—Ä—É) –Ω–µ –Ω–∞–≤—è–∑—ã–≤–∞–π –æ–±—Å—É–∂–¥–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞.

–ù–î–§–õ vs –ù–ê–õ–û–ì –ù–ê –ü–†–ò–ë–´–õ–¨:
- –ù–∞–ª–æ–≥ –Ω–∞ –ø—Ä–∏–±—ã–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π (–≥–ª. 25 –ù–ö –†–§) ‚Äî –¥–ª—è —é—Ä–ª–∏—Ü.
- –ù–î–§–õ (–≥–ª. 23 –ù–ö –†–§) ‚Äî –¥–ª—è —Ñ–∏–∑–ª–∏—Ü.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –Ω–∞–ª–æ–≥ –Ω–∞ –ø—Ä–∏–±—ã–ª—å ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–æ—Ä–º—ã –ù–î–§–õ –∫–∞–∫ –æ—Å–Ω–æ–≤—É. –î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —É–ø–æ–º—è–Ω—É—Ç—å –ù–î–§–õ –æ—Ç–¥–µ–ª—å–Ω–æ –∫–∞–∫ –∏–Ω–æ–π –Ω–∞–ª–æ–≥ —Å –¥—Ä—É–≥–∏–º —Å—É–±—ä–µ–∫—Ç–æ–º.

–ò–°–¢–û–ß–ù–ò–ö–ò –ò –°–°–´–õ–ö–ò:
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Å—Ç–∞—Ç—å–∏ –ù–ö –†–§, –ø–∏—Å—å–º–∞, —Å—É–¥–µ–±–Ω—ã–µ –∞–∫—Ç—ã –∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã.
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –µ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.
- –ï—Å–ª–∏ –Ω–æ—Ä–º—ã/–ø—Ä–∞–∫—Ç–∏–∫–∏ –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ‚Äî –ø–∏—à–∏: ¬´–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç+ –∏–ª–∏ –Ω–∞ pravo.gov.ru¬ª.
- –§–æ—Ä–º–∞—Ç —Å—Å—ã–ª–æ–∫ (HTML –¥–ª—è Telegram): <a href="URL">—Ç–µ–∫—Å—Ç</a>. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π ¬´–ò—Å—Ç–æ—á–Ω–∏–∫ 1/2/3¬ª.
- –ù–∞–∑–≤–∞–Ω–∏—è –¥–µ–ª–∞–π –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º–∏, 2‚Äì4 —Å–ª–æ–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: <a href="URL">–ü–∏—Å—å–º–æ –ú–∏–Ω—Ñ–∏–Ω–∞</a>, <a href="URL">–ê–¥–≤–æ–∫–∞—Ç—Å–∫–∞—è –≥–∞–∑–µ—Ç–∞</a>).
- –ü—Ä–∏–º–µ—Ä –≤ —Ç–µ–∫—Å—Ç–µ: ¬´–ü–æ –¥–∞–Ω–Ω—ã–º <a href="https://advgazeta.ru/...">–ê–¥–≤–æ–∫–∞—Ç—Å–∫–æ–π –≥–∞–∑–µ—Ç—ã</a>, —Å 2026 –≥–æ–¥–∞...¬ª

–†–ê–ó–ú–ï–¢–ö–ê:
- –î–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π HTML‚Äë—Ç–µ–≥–∏: <b>–∂–∏—Ä–Ω—ã–π</b>, <i>–∫—É—Ä—Å–∏–≤</i>, <code>–∫–æ–¥</code>.
- –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ –≤—ã–¥–µ–ª—è–π –∂–∏—Ä–Ω—ã–º: <b>1. –°—É—Ç—å</b>, <b>2. –ù–æ—Ä–º–∞</b>, <b>3. –ü—Ä–∞–∫—Ç–∏–∫–∞</b>, <b>4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</b>.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown.

–ù–ï–û–ü–†–ï–î–ï–õ–Å–ù–ù–û–°–¢–¨:
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî –ø–µ—Ä–µ—á–∏—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ–∞–∫—Ç—ã (—Å—Ç–æ—Ä–æ–Ω—ã, —Ä–µ–∑–∏–¥–µ–Ω—Ç—Å—Ç–≤–æ, —Å—Ä–æ–∫ –≤–ª–∞–¥–µ–Ω–∏—è, –æ–±—ä–µ–∫—Ç, —Ä–µ–∂–∏–º –∏ —Ç.–¥.) –∏ –ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å.
- –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ ‚Äî –æ–ø–∏—à–∏ –∫–∞–∂–¥—ã–π —Å —Ä–∏—Å–∫–∞–º–∏.

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
<b>1. –°—É—Ç—å</b> ‚Äî 2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
<b>2. –ù–æ—Ä–º–∞</b> ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–æ—Ä–º—ã —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏. –ï—Å–ª–∏ –Ω–æ—Ä–º –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ‚Äî —É–∫–∞–∂–∏ –≥–ª–∞–≤—É/–æ–±—â–µ–µ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏. –ï—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏ –æ–±—â–∏–µ –Ω–æ—Ä–º—ã –¥–ª—è –û–°–ù–û (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–ª. 25 –ù–ö –†–§ –¥–ª—è –Ω–∞–ª–æ–≥–∞ –Ω–∞ –ø—Ä–∏–±—ã–ª—å), –∑–∞—Ç–µ–º ‚Äî –∏—Å–∫–ª—é—á–µ–Ω–∏—è/–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å–ø–µ—Ü—Ä–µ–∂–∏–º–æ–≤ (–£–°–ù, –ï–°–•–ù –∏ –¥—Ä.).
<b>3. –ü—Ä–∞–∫—Ç–∏–∫–∞</b> ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ —Ç–æ–º—É –∂–µ –Ω–∞–ª–æ–≥—É –∏ —Å—É–±—ä–µ–∫—Ç—É. –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Tavily –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –ù–î–§–õ —Ñ–∏–∑–ª–∏—Ü, –∞ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –Ω–∞–ª–æ–≥–∞ –Ω–∞ –ø—Ä–∏–±—ã–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π ‚Äî —è–≤–Ω–æ –Ω–∞—á–Ω–∏ –ø–æ–¥–ø—É–Ω–∫—Ç: ¬´–î–ª—è —Å–ø—Ä–∞–≤–∫–∏ (–ø—Ä–∏–º–µ–Ω–∏–º–æ –∫ —Ñ–∏–∑–ª–∏—Ü–∞–º, –ù–ï –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º): ‚Ä¶¬ª. –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ –¥—Ä—É–≥–æ–º—É –Ω–∞–ª–æ–≥—É ‚Äî –≤—ã–Ω–µ—Å–∏ –æ—Ç–¥–µ–ª—å–Ω–æ –∏ —è–≤–Ω–æ –ø–æ—è—Å–Ω–∏. –ï—Å–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –Ω–µ—Ç: ¬´–í –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è —Å—É–¥–µ–±–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –∏–ª–∏ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –≠—Ç–æ –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç –µ—ë –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ.¬ª
<b>4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</b> ‚Äî —á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ, –≥–¥–µ –Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç (–∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏, —Å–∞–Ω–∫—Ü–∏–∏, —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è), –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã/—Ñ–∞–∫—Ç—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å.

–ù–æ—Ä–º—ã (–ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã/–ù–ö –†–§):
{law_context}

–ü—Ä–∞–∫—Ç–∏–∫–∞ (Tavily):
{web_results}

–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:
{history}

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
{user_query}

–î–ò–°–ö–õ–ï–ô–ú–ï–† (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–æ–π, –Ω–µ –¥—É–±–ª–∏—Ä—É–π): ¬´–û—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ò–ò –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π. –î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π –ø–æ —Å–¥–µ–ª–∫–∞–º, –ø–æ–¥–∞—á–µ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π –∏–ª–∏ —Å–ø–æ—Ä–∞–º —Å –Ω–∞–ª–æ–≥–æ–≤—ã–º–∏ –æ—Ä–≥–∞–Ω–∞–º–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞–ª–æ–≥–æ–≤–æ–º—É –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É.¬ª
"""
        return prompt

    async def generate_response(self, prompt: str, image_urls: list[str] | None = None) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ OpenRouter"""
        if not self.client:
            return "‚ùå –û—à–∏–±–∫–∞: API –∫–ª—é—á OpenRouter –Ω–µ –Ω–∞–π–¥–µ–Ω."

        try:
            content: list[dict] = [{"type": "text", "text": prompt}]
            if image_urls:
                for url in image_urls:
                    content.append({"type": "image_url", "image_url": {"url": url}})

            async def _call(model_name: str):
                return await self.client.chat.completions.create(
                    model=model_name,
                    messages=[{"role": "user", "content": content}],
                    temperature=0.3,
                    max_tokens=2000,
                )

            models = [config.MODEL_NAME]
            for m in config.MODEL_FALLBACKS:
                if m and m not in models:
                    models.append(m)

            last_err: Exception | None = None
            for idx, model_name in enumerate(models):
                try:
                    response = await _call(model_name)
                    return response.choices[0].message.content
                except Exception as e:
                    last_err = e
                    if idx < len(models) - 1:
                        logger.warning(f"Model failed, trying fallback: {models[idx + 1]}. Error: {e}")

            return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {str(last_err)}"
        except Exception as e:
            return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {str(e)}"

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
llm_client = LLMClient()
